{% extends "base.html.twig" %}
{# Edit product view. List products for editing, and allow editing them. Only admin users get to this view.
Editing works by pressing the "edit product" button. It gets the form with pre-filled values from a controller
through jQuery Ajax. You then submit the form, the product is updated in the database and you return to this view
with a success message.

You can also make produts featured or remove them from featured products, also works with ajax.

#}
{% block title %}
    Edit products
{% endblock %}
{% block body %}


    <div id="result">
        {# Display success or other message coming from a controller. #}
        {% if app.request.get('message') is defined %}
            {{ app.request.get('message') }}
        {% endif %}
    </div>
    <div id="edit-product-form">
    </div>

    {% if products is defined %}
        <table class="table">
            {# loop through products array. Lists products and options for editing. #}
            {% for product in products %}
                <tr>
                    <td>Product: {{ product.name }}</td>
                    <td>Product price:{{ product.price }}</td>
                    <td><img src="{{ asset("images/") ~ product.imageFileName }}" alt="product image" class="img-thumbnail"></td>
                    {% if product.featured %}
                        <td><button class="btn btn-danger" onclick="unfeature_product({{ product.id }})">Remove from featured products</button></td>
                    {% else %}
                        <td><button class="btn btn-secondary" onclick="make_product_featured({{ product.id }})">Make product featured</button></td>
                    {% endif %}
                </tr>
                <tr>
                    <td><button class="btn btn-primary" onclick="edit_product({{ product.id }})">Edit product</button></td>
                    <td><button class="btn btn-danger" onclick="remove_product({{ product.id }})">Remove product</button></td>
                </tr>
            {% endfor %}
        </table>
        {% else %}
        <h4>No products to edit!</h4>
    {% endif %}

{%  endblock %}

{% block javascripts %}
<script>

    /**
     * Ajax stuff here for controller actions related to this view/template.
     *
     * Using jQuery.
     */

    function make_product_featured(product_id) {
        var url = "{{ path("make_product_featured") }}" +"?id=" + product_id;
        $.ajax({
            url: url, success: function (result) {
                process_result(result)
            }
        });
    }

    function unfeature_product(product_id) {
        var url = "{{ path("unfeature_product") }}" +"?id=" + product_id;
        $.ajax({
            url: url, success: function (result) {
                process_result(result)
            }
        });
    }

    function edit_product(product_id) {
        var url = "{{ path("edit_product") }}" +"?id=" + product_id;
        $.ajax({
            url: url, success: function (result) {
                process_form(result)
            }
        });
    }

    function remove_product(product_id) {
        var url = "{{ path("remove_product") }}" +"?id=" + product_id;
        $.ajax({
            url: url, success: function (result) {
                process_result(result)
            }
        });
    }

    function process_result(result) {
        $("#result").html(result)
        setTimeout(function() {
            location.reload(); }, 1500);
    }

    function process_form(result) {
        $("#edit-product-form").html(result);
    }
</script>
{% endblock %}
